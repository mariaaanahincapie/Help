<!-- serconn_app/templates/serconn_app/service_search.html -->

<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Búsqueda de Servicios - SERCONN</title>
    <!-- Incluyendo Tailwind CSS desde su CDN para un estilo rápido y moderno -->
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&family=Roboto:ital,wght@0,100..900;1,100..900&display=swap');

        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f7f9fb; /* Un fondo claro y suave */
        }
    </style>
</head>
<body class="flex flex-col min-h-screen">
    <!-- Barra de navegación superior (Header) -->
    <header class="bg-white shadow-sm py-4 px-6 md:px-12 flex justify-between items-center sticky top-0 z-50">
        <h1 class="text-2xl font-bold text-gray-800">
            <a href="{% url 'service_search' %}">SERCONN</a>
        </h1>
        <nav class="flex items-center gap-4">
            <a href="{% url 'service_search' %}" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-full transition-colors duration-300 shadow-md">
                Buscar Servicios
            </a>
            {% if user.is_authenticated %}
                <div class="relative">
                    <button id="profile-menu-btn" class="flex items-center gap-2 bg-gray-100 hover:bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-full transition-colors duration-300">
                        {% if user.serviceprovider.profile_picture %}
                            <img src="{{ user.serviceprovider.profile_picture.url }}" alt="Perfil" class="w-8 h-8 rounded-full object-cover">
                        {% else %}
                            <span class="w-8 h-8 rounded-full bg-gray-300 flex items-center justify-center font-bold">{{ user.username|slice:":1" }}</span>
                        {% endif %}
                        {{ user.get_full_name|default:user.username }}
                    </button>
                    <div id="profile-dropdown" class="absolute right-0 mt-2 w-48 bg-white border rounded-lg shadow-lg hidden z-50">
                        <a href="{% url 'provider_profile' %}" class="block px-4 py-2 hover:bg-indigo-50 text-gray-700">Editar perfil</a>
                        <a href="{% url 'seeker_dashboard' %}" class="block px-4 py-2 hover:bg-indigo-50 text-gray-700">Ver mis solicitudes</a>
                        <form action="{% url 'logout' %}" method="post" style="margin:0;">
                            {% csrf_token %}
                            <button type="submit" class="block w-full text-left px-4 py-2 hover:bg-indigo-50 text-gray-700" style="background:none;border:none;">Cerrar sesión</button>
                        </form>
                    </div>
                </div>
            {% else %}
                <a href="{% url 'login' %}" class="text-indigo-600 hover:text-indigo-800 font-semibold px-4 py-2">Iniciar sesión</a>
                <a href="{% url 'register' %}" class="text-indigo-600 hover:text-indigo-800 font-semibold px-4 py-2">Registrarse</a>
            {% endif %}
        </nav>
    </header>

    <main class="container mx-auto px-4 py-8 md:py-12 flex-grow">
        <div class="bg-white p-6 md:p-8 rounded-2xl shadow-xl max-w-2xl mx-auto">
            <h2 class="text-3xl font-bold text-center text-gray-800 mb-6">Encuentra el Servicio que Necesitas</h2>
            <form action="{% url 'service_search' %}" method="get" class="space-y-4">
                <div class="flex flex-col md:flex-row gap-4">
                    <!-- Campo de búsqueda por palabra clave (FR-3) -->
                    <input type="text" name="query" placeholder="Ej: Plomero, Tutor de inglés..." value="{{ query|default:'' }}" 
                           class="flex-1 p-3 border border-gray-300 rounded-full focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-all duration-200">
                    
                    <!-- Filtro por categoría (FR-2) -->
                    <select name="category" class="p-3 border border-gray-300 rounded-full focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-all duration-200">
                        <option value="">Todas las categorías</option>
                        {% for category in categories %}
                            <option value="{{ category.name }}" {% if category.name == selected_category %}selected{% endif %}>
                                {{ category.name }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
                <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-full transition-colors duration-300 shadow-lg">
                    Buscar
                </button>
            </form>
        </div>

        <section class="mt-12">
            <h2 class="text-3xl font-bold text-gray-800 mb-6 text-center">Resultados de Búsqueda</h2>
            {% if providers %}
                <ul class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
                    {% for provider in providers %}
                        {% if provider.services.count > 0 %}
                            <li class="bg-white p-6 rounded-2xl shadow-md hover:shadow-xl transition-shadow duration-300 flex flex-col">
                                <!-- Enlace al perfil del proveedor (FR-5) -->
                                <a href="{% url 'provider_detail' provider.id %}" class="flex-grow">
                                    <div class="flex items-center mb-4">
                                        {% if provider.profile_picture %}
                                            <img src="{{ provider.profile_picture.url }}" alt="Foto de perfil de {{ provider.user }}" class="w-16 h-16 rounded-full object-cover mr-4">
                                        {% else %}
                                            <div class="w-16 h-16 rounded-full bg-gray-200 flex items-center justify-center text-gray-500 text-xl font-bold mr-4">
                                                {{ provider.user|slice:":1" }}
                                            </div>
                                        {% endif %}
                                        <div>
                                            <h3 class="text-xl font-semibold text-indigo-600 hover:text-indigo-800 transition-colors duration-200">{{ provider.user }}</h3>
                                            <p class="text-sm text-gray-500">Proveedor de servicios</p>
                                        </div>
                                    </div>
                                    <p class="text-gray-600 mt-2">{{ provider.service_info|truncatewords:25 }}</p>
                                </a>
                                {% if user.is_authenticated and user == provider.user %}
                                    <a href="{% url 'seeker_dashboard' %}" class="text-indigo-600 hover:underline font-semibold block mt-2">Ver mis solicitudes</a>
                                {% endif %}
                                <div class="mt-4 pt-4 border-t border-gray-100">
                                    <h4 class="font-semibold text-gray-700 mb-2">Servicios que ofrece:</h4>
                                    <ul class="list-disc list-inside text-gray-600">
                                        {% for service in provider.services.all|slice:":3" %}
                                            <li>{{ service.name }} - <span class="font-bold">${{ service.rate|floatformat:0 }}</span></li>
                                        {% endfor %}
                                        {% if provider.services.count > 3 %}
                                            <li class="text-sm text-gray-500">...y más.</li>
                                        {% endif %}
                                    </ul>
                                </div>
                            </li>
                        {% endif %}
                    {% endfor %}
                </ul>
            {% else %}
                <div class="text-center text-gray-500 p-8 bg-gray-50 rounded-2xl shadow-inner">
                    <p class="text-lg">No se encontraron proveedores que coincidan con la búsqueda.</p>
                    <p class="mt-2">Intenta con otros términos o categorías.</p>
                </div>
            {% endif %}
        </section>

        {% if user.is_authenticated %}
            <div class="max-w-md mx-auto mt-8 bg-white rounded-2xl shadow-lg p-6 flex items-center gap-6">
                {% if user.serviceprovider.profile_picture %}
                    <img src="{{ user.serviceprovider.profile_picture.url }}" alt="Foto de perfil" class="w-20 h-20 rounded-full object-cover">
                {% else %}
                    <div class="w-20 h-20 rounded-full bg-gray-200 flex items-center justify-center text-gray-500 text-2xl font-bold">
                        {{ user.username|slice:":1" }}
                    </div>
                {% endif %}
                <div>
                    <h3 class="text-xl font-bold text-indigo-700">{{ user.get_full_name|default:user.username }}</h3>
                    <p class="text-gray-600">{{ user.serviceprovider.profession }}</p>
                    <p class="text-gray-600">{{ user.serviceprovider.contact_number }}</p>
                    <p class="text-gray-600">{{ user.serviceprovider.services_offered }}</p>
                    <a href="{% url 'seeker_dashboard' %}" class="text-indigo-600 hover:underline font-semibold block mt-2">Ver mis solicitudes</a>
                </div>
            </div>
        {% endif %}
    </main>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const menuBtn = document.getElementById('profile-menu-btn');
        const dropdown = document.getElementById('profile-dropdown');

        if (menuBtn && dropdown) {
            menuBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                dropdown.classList.toggle('hidden');
            });

            document.addEventListener('click', function(e) {
                if (!dropdown.classList.contains('hidden')) {
                    dropdown.classList.add('hidden');
                }
            });

            dropdown.addEventListener('click', function(e) {
                e.stopPropagation();
            });
        }
    });
    </script>
</body>
</html>

{% comment %}
Desde la vista, asegurarse de pasar el contexto adecuado a la plantilla, incluyendo 'providers', 'categories', 'query' y 'selected_category'.

Ejemplo de cómo podría lucir la vista:

from django.shortcuts import render
from .models import ServiceProvider, Category

def service_search(request):
    query = request.GET.get('query', '')
    selected_category = request.GET.get('category', '')
    
    providers = ServiceProvider.objects.filter(
        Q(service_info__icontains=query) |
        Q(profession__icontains=query) |
        Q(services_offered__icontains=query)
    ).distinct()

    categories = Category.objects.all()

    return render(request, 'serconn_app/service_search.html', {
        'providers': providers,
        'categories': categories,
        'query': query,
        'selected_category': selected_category
    })
{% endcomment %}
